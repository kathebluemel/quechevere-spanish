<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spanish Level 1 | Seño Bluemel Que Chévere</title>

  <!-- Google Classroom Share button -->
  <script src="https://apis.google.com/js/platform.js" async defer></script>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121923;
      --panel2:#0f1620;
      --text:#e8eef6;
      --muted:#b7c4d6;
      --line:rgba(255,255,255,.10);
      --accent:#4aa3ff;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:12px;
      --max:1100px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:var(--max);margin:0 auto;padding:22px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:16px 18px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
    }
    .title h1{margin:0;font-size:28px;letter-spacing:.2px}
    .title .sub{margin-top:4px;color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);font-weight:700;font-size:12px
    }
    .btn{
      padding:9px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);color:var(--text);
      font-weight:800;font-size:12px;cursor:pointer
    }
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn-danger{border-color:rgba(251,113,133,.55);background:rgba(251,113,133,.08)}
    .btn-danger:hover{border-color:rgba(251,113,133,.85)}
    .btn-home{display:inline-flex;gap:8px;align-items:center}

    .card{
      margin-top:16px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      padding:16px 18px
    }

    .row{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12px}
    .progressWrap{margin-top:10px}
    .bar{
      height:10px;border-radius:999px;background:rgba(255,255,255,.08);
      border:1px solid var(--line);overflow:hidden
    }
    .bar>div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, var(--accent), var(--good));
      transition:width .25s ease;
    }

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:14px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }

    .unit{
      border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      padding:16px 16px 14px 16px;
      position:relative;
      overflow:hidden;
    }
    .unit h3{margin:0 0 6px 0;font-size:18px}
    .unit p{margin:0;color:var(--muted);font-size:12px;line-height:1.35}
    .unit .unitBar{margin-top:12px}
    .unit .unitMeta{
      margin-top:8px;
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .unit .pct{font-weight:900;font-size:12px}
    .unit .shareRow{
      margin-top:10px;
      display:flex;align-items:center;gap:10px;
      color:var(--muted);
      font-size:12px;
    }
    .shareLabel{opacity:.95}
    .footer{
      margin-top:22px;
      text-align:center;
      color:var(--muted);
      font-size:12px;
      opacity:.9;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Spanish Level 1</h1>
        <div class="sub">Stage-Based ACTFL Curriculum — Seño Bluemel Que Chévere</div>
      </div>
      <div class="actions">
        <a class="btn btn-home" href="../index.html">← Home</a>
        <span class="pill" id="overallPill">Overall: 0% complete</span>
        <button class="btn btn-danger" id="resetAllBtn">Reset ALL Level 1 Progress</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div style="font-weight:900;letter-spacing:.06em;font-size:12px">OVERALL PROGRESS</div>
          <div class="muted">Tip: Progress is saved in your browser (localStorage).</div>
        </div>
        <div class="pill" id="unitsPill">Units: 8 • Stages: 5 each</div>
      </div>
      <div class="progressWrap">
        <div class="bar"><div id="overallBar"></div></div>
      </div>
    </div>

    <div class="grid" id="unitGrid"></div>

    <div class="footer">© Seño Bluemel Que Chévere</div>
  </div>

  <script>
    // -----------------------------
    // Dashboard config
    // -----------------------------
    const STAGE_COUNT = 5;

    const UNITS = [
      { n: 1, title: "Unit 1 — Identity & First Encounters", desc: "Greetings, introductions, basic personal information.", href: "unit-1/" },
      { n: 2, title: "Unit 2 — Numbers & Classroom Language", desc: "Numbers, classroom objects, essential communication phrases.", href: "unit-2/" },
      { n: 3, title: "Unit 3 — Descriptions & Adjectives", desc: "Physical descriptions, adjectives, agreement, basic traits.", href: "unit-3/" },
      { n: 4, title: "Unit 4 — Daily Life & Schedules", desc: "Daily routines, time telling, sequencing, simple preferences.", href: "unit-4/" },
      { n: 5, title: "Unit 5 — Food & Preferences", desc: "Likes/dislikes, simple requests, ordering politely.", href: "unit-5/" },
      { n: 6, title: "Unit 6 — Free Time & Hobbies", desc: "Activities you do, what you like to do, and when.", href: "unit-6/" },
      { n: 7, title: "Unit 7 — Family & Relationships", desc: "Family members, relationships, and describing people in your world.", href: "unit-7/" },
      { n: 8, title: "Unit 8 — La Vida Escolar", desc: "Your classes, your schedule, what you need for school, and how your school day shapes your identity.", href: "unit-8/" }
    ];

    // -----------------------------
    // Helpers
    // -----------------------------
    function truthy(v){
      if (v === null || v === undefined) return false;
      const s = String(v).trim().toLowerCase();
      return s === "1" || s === "true" || s === "yes" || s === "done" || s === "y" || s === "on";
    }

    // Base URL builder for Classroom share
    function shareUrlForUnit(unitHref){
      const base = location.origin + location.pathname.replace(/\/level-1\/index\.html.*$/,"/level-1/");
      return base + unitHref;
    }

    // -----------------------------
    // SMART SCAN: Detect any progress keys
    // This is the part that fixes "units save, but dashboard shows 0"
    // -----------------------------
    function buildDetectedDoneMap(){
      // doneMap[unit][stage] = true/false
      const doneMap = {};
      for (const u of UNITS){
        doneMap[u.n] = {};
        for (let s=1; s<=STAGE_COUNT; s++) doneMap[u.n][s] = false;
      }

      const keys = Object.keys(localStorage);

      // Regex patterns to catch MANY formats:
      // unit-6 stage-3, unit6_stage3, u6s3, sbqc:l1:u6:s3, etc.
      const patterns = [
        /unit[\s\-_]*([0-9]+)[\s\-_]*(?:stage|s)[\s\-_]*([0-9]+)/i,
        /u([0-9]+)[\s\-_]*s([0-9]+)/i,
        /sbqc.*?u([0-9]+).*?s([0-9]+)/i,
        /level[\s\-_]*1.*?unit[\s\-_]*([0-9]+).*?(?:stage|s)[\s\-_]*([0-9]+)/i
      ];

      for (const k of keys){
        const v = localStorage.getItem(k);

        // 1) boolean-ish values
        if (truthy(v)){
          for (const re of patterns){
            const m = k.match(re);
            if (m){
              const unit = parseInt(m[1], 10);
              const stage = parseInt(m[2], 10);
              if (doneMap[unit] && doneMap[unit][stage] !== undefined){
                doneMap[unit][stage] = true;
              }
            }
          }
        }

        // 2) JSON blobs that store stages
        if (v && (v.startsWith("{") || v.startsWith("["))){
          try{
            const obj = JSON.parse(v);
            // If key includes unit number, try to extract it:
            let unitGuess = null;
            const mUnit = k.match(/unit[\s\-_]*([0-9]+)/i) || k.match(/u([0-9]+)/i);
            if (mUnit) unitGuess = parseInt(mUnit[1], 10);

            if (!unitGuess || !doneMap[unitGuess]) continue;

            if (Array.isArray(obj)){
              for (let i=0; i<obj.length && i<STAGE_COUNT; i++){
                if (obj[i]) doneMap[unitGuess][i+1] = true;
              }
            } else if (obj && typeof obj === "object"){
              for (let s=1; s<=STAGE_COUNT; s++){
                if (obj[String(s)] !== undefined && !!obj[String(s)]) doneMap[unitGuess][s] = true;
                if (obj[`stage${s}`] !== undefined && !!obj[`stage${s}`]) doneMap[unitGuess][s] = true;
                if (obj.stages && obj.stages[String(s)] !== undefined && !!obj.stages[String(s)]) doneMap[unitGuess][s] = true;
                if (obj.stages && obj.stages[`stage${s}`] !== undefined && !!obj.stages[`stage${s}`]) doneMap[unitGuess][s] = true;
              }
            }
          }catch(e){}
        }
      }

      return doneMap;
    }

    function unitPctFromMap(doneMap, unitNum){
      let done = 0;
      for (let s=1; s<=STAGE_COUNT; s++){
        if (doneMap[unitNum] && doneMap[unitNum][s]) done++;
      }
      return Math.round((done / STAGE_COUNT) * 100);
    }

    function overallPctFromMap(doneMap){
      const totalStages = UNITS.length * STAGE_COUNT;
      let doneStages = 0;
      for (const u of UNITS){
        for (let s=1; s<=STAGE_COUNT; s++){
          if (doneMap[u.n] && doneMap[u.n][s]) doneStages++;
        }
      }
      return Math.round((doneStages / totalStages) * 100);
    }

    // Reset ALL progress (aggressive)
    function clearAllProgress(){
      const keys = Object.keys(localStorage);
      for (const k of keys){
        const lk = k.toLowerCase();
        const looksLikeProgress =
          lk.includes("unit") || lk.includes("stage") || lk.includes("level1") || lk.includes("level-1") || lk.includes("sbqc") || /u\d+/.test(lk);
        if (looksLikeProgress){
          localStorage.removeItem(k);
        }
      }
      render();
    }

    function render(){
      document.getElementById("unitsPill").textContent = `Units: ${UNITS.length} • Stages: ${STAGE_COUNT} each`;

      const doneMap = buildDetectedDoneMap();

      const op = overallPctFromMap(doneMap);
      document.getElementById("overallPill").textContent = `Overall: ${op}% complete`;
      document.getElementById("overallBar").style.width = op + "%";

      const grid = document.getElementById("unitGrid");
      grid.innerHTML = "";

      UNITS.forEach(u => {
        const pct = unitPctFromMap(doneMap, u.n);

        const card = document.createElement("div");
        card.className = "unit";

        const link = document.createElement("a");
        link.href = u.href;
        link.innerHTML = `
          <h3>${u.title}</h3>
          <p>${u.desc}</p>
        `;

        const unitBar = document.createElement("div");
        unitBar.className = "unitBar";
        unitBar.innerHTML = `<div class="bar"><div style="width:${pct}%"></div></div>`;

        const meta = document.createElement("div");
        meta.className = "unitMeta";
        meta.innerHTML = `<div class="muted" style="font-weight:800;">Progress</div><div class="pct">${pct}%</div>`;

        const shareRow = document.createElement("div");
        shareRow.className = "shareRow";
        const shareUrl = shareUrlForUnit(u.href);
        shareRow.innerHTML = `
          <g:sharetoclassroom url="${shareUrl}" size="32"></g:sharetoclassroom>
          <span class="shareLabel">Post this unit to Google Classroom</span>
        `;

        card.appendChild(link);
        card.appendChild(meta);
        card.appendChild(unitBar);
        card.appendChild(shareRow);

        grid.appendChild(card);
      });

      // Re-render Google Classroom widgets after dynamic insertion
      if (window.gapi && window.gapi.sharetoclassroom && window.gapi.sharetoclassroom.go){
        window.gapi.sharetoclassroom.go();
      }
    }

    document.getElementById("resetAllBtn").addEventListener("click", () => {
      if (confirm("Reset ALL Level 1 progress for all units on THIS device/browser?")){
        clearAllProgress();
      }
    });

    render();
  </script>
</body>
</html>
