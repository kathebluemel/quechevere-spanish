<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spanish Level 1 | Seño Bluemel Que Chévere</title>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121923;
      --panel2:#0f1620;
      --text:#e8eef6;
      --muted:#b7c4d6;
      --line:rgba(255,255,255,.10);
      --accent:#4aa3ff;
      --good:#34d399;
      --bad:#fb7185;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --max:1100px;
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:var(--max);margin:0 auto;padding:22px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 16px;border:1px solid var(--line);border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
    }
    .brand h1{margin:0;font-size:28px}
    .brand p{margin:4px 0 0;color:var(--muted);font-size:13px}

    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-weight:800;font-size:13px;
    }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      font-weight:800;font-size:13px;
      cursor:pointer;
    }
    .btn:hover{border-color:rgba(74,163,255,.55)}
    .btn-danger{border-color:rgba(251,113,133,.45)}
    .btn-danger:hover{border-color:rgba(251,113,133,.75)}

    .panel{
      margin-top:16px;
      padding:16px;border:1px solid var(--line);border-radius:20px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
    }
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .panelHead h2{margin:0;font-size:14px;letter-spacing:.12em;text-transform:uppercase;color:#cfe2ff}
    .hint{margin:0;color:var(--muted);font-size:12px}

    .bar{
      height:10px;border-radius:999px;background:rgba(255,255,255,.06);
      overflow:hidden;border:1px solid var(--line);
    }
    .barFill{
      height:100%;width:0%;
      background:linear-gradient(90deg, var(--accent), var(--good));
      transition:width .25s ease;
    }

    .grid{
      display:grid;gap:14px;margin-top:16px;
      grid-template-columns:repeat(2, minmax(0,1fr));
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
      .actions{justify-content:flex-start}
    }

    .card{
      padding:16px;border-radius:20px;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      cursor:pointer;
    }
    .card:hover{border-color:rgba(74,163,255,.55)}
    .card h3{margin:0 0 6px;font-size:18px}
    .card p{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.35}

    .cardRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-size:12px;color:var(--muted);margin-top:8px;
    }
    .pct{font-weight:900;color:var(--text)}
    .footer{margin:18px 0 0;text-align:center;color:var(--muted);font-size:12px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Spanish Level 1</h1>
        <p>Stage-Based ACTFL Curriculum — Seño Bluemel Que Chévere</p>
      </div>
      <div class="actions">
        <a class="btn" href="../index.html">← Home</a>
        <span class="pill" id="overallPill">Overall: 0% complete</span>
        <button class="btn btn-danger" id="resetAllBtn" type="button">Reset ALL Level 1 Progress</button>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <h2>Overall Progress</h2>
        <span class="pill" id="metaPill">Units: 7 • Stages: 5 each</span>
        <p class="hint">Tip: Progress is saved in your browser (localStorage).</p>
      </div>
      <div class="bar"><div class="barFill" id="overallBar"></div></div>
    </div>

    <div class="grid" id="unitGrid"></div>

    <div class="footer">© Seño Bluemel Que Chévere</div>
  </div>

  <script>
    const STAGE_COUNT = 5;

    const UNITS = [
      { n: 1, title: "Unit 1 — Identity & First Encounters", desc: "Greetings, introductions, basic personal information.", href: "unit-1/" },
      { n: 2, title: "Unit 2 — Numbers & Classroom Language", desc: "Numbers, classroom objects, essential communication phrases.", href: "unit-2/" },
      { n: 3, title: "Unit 3 — Descriptions & Adjectives", desc: "Physical descriptions, adjectives, agreement, basic traits.", href: "unit-3/" },
      { n: 4, title: "Unit 4 — Daily Life & Schedules", desc: "Daily routines, time telling, sequencing, simple preferences.", href: "unit-4/" },
      { n: 5, title: "Unit 5 — Food & Preferences", desc: "Likes/dislikes, simple requests, ordering politely.", href: "unit-5/" },
      { n: 6, title: "Unit 6 — Free Time & Hobbies", desc: "Activities you do, what you like to do, and when.", href: "unit-6/" },
      { n: 7, title: "Unit 7 — Family & Relationships", desc: "Family members, relationships, and basic descriptions.", href: "unit-7/" },
    ];

    // -----------------------------
    // UNIVERSAL progress reader
    // -----------------------------
    function truthy(v){
      const s = String(v ?? "").toLowerCase().trim();
      return s === "true" || s === "1" || s === "yes" || s === "done" || s === "complete" || s === "checked";
    }

    function getKeys(){
      const out = [];
      for (let i = 0; i < localStorage.length; i++) out.push(localStorage.key(i));
      return out.filter(Boolean);
    }

    function parseUnitStageFromKey(key){
      const k = key.toLowerCase();

      // unit-6-stage-3 / unit_6_stage_3 / unit6stage3 / u6s3 / u6-stage3
      let m = k.match(/(?:unit|u)\s*[-_:]?\s*(\d+)[^0-9a-z]+(?:stage|s)\s*[-_:]?\s*(\d+)/i);
      if (m) return { unit: Number(m[1]), stage: Number(m[2]) };

      m = k.match(/(?:unit|u)\s*(\d+).*?(?:stage|s)\s*(\d+)/i);
      if (m) return { unit: Number(m[1]), stage: Number(m[2]) };

      // qc:l1:u6:s3
      m = k.match(/:u(\d+):s(\d+)/i);
      if (m) return { unit: Number(m[1]), stage: Number(m[2]) };

      // stage-first
      m = k.match(/(?:stage|s)\s*[-_:]?\s*(\d+).*?(?:unit|u)\s*[-_:]?\s*(\d+)/i);
      if (m) return { unit: Number(m[2]), stage: Number(m[1]) };

      return null;
    }

    function extractDoneStagesFromJSON(obj){
      // Accepts MANY shapes:
      // {stages:[true,false,...]}
      // {done:[true,false,...]}
      // {stageDone:{1:true,2:false}}
      // {stagesDone:{'1':true}}
      // {1:true,2:false} (direct map)
      const done = new Array(STAGE_COUNT + 1).fill(false);

      if (!obj || typeof obj !== "object") return done;

      const tryArray = (arr) => {
        if (!Array.isArray(arr)) return;
        for (let i = 1; i <= STAGE_COUNT; i++){
          if (arr[i-1] === true) done[i] = true;
        }
      };

      tryArray(obj.stages);
      tryArray(obj.done);
      tryArray(obj.stageDone);
      tryArray(obj.stagesDone);

      const tryMap = (m) => {
        if (!m || typeof m !== "object") return;
        for (let i = 1; i <= STAGE_COUNT; i++){
          if (m[i] === true || m[String(i)] === true) done[i] = true;
        }
      };

      tryMap(obj.stageDone);
      tryMap(obj.stagesDone);
      tryMap(obj.doneMap);
      tryMap(obj.doneStages);

      // direct numeric keys
      tryMap(obj);

      return done;
    }

    function getUnitDoneCount(unitNum){
      const done = new Array(STAGE_COUNT + 1).fill(false);
      const keys = getKeys();

      // 1) Key-based stage booleans
      for (const key of keys){
        const parsed = parseUnitStageFromKey(key);
        if (!parsed) continue;
        if (parsed.unit !== unitNum) continue;
        if (parsed.stage < 1 || parsed.stage > STAGE_COUNT) continue;

        if (truthy(localStorage.getItem(key))) done[parsed.stage] = true;
      }

      // 2) Unit-level JSON blobs (any key containing unit number)
      // This is the missing piece in your situation.
      const unitNeedle = String(unitNum);
      for (const key of keys){
        const k = key.toLowerCase();
        if (!(k.includes("unit") || k.includes("u") || k.includes("level"))) continue;
        if (!k.match(new RegExp(`\\b${unitNeedle}\\b`))) {
          // also catch "unit-6" / "unit6" / "u6"
          if (!k.includes(`unit-${unitNum}`) && !k.includes(`unit_${unitNum}`) && !k.includes(`unit${unitNum}`) && !k.includes(`u${unitNum}`)) continue;
        }

        const raw = localStorage.getItem(key);
        if (!raw) continue;

        // If it's JSON, try to pull stage booleans from it
        if (raw.trim().startsWith("{") || raw.trim().startsWith("[")){
          try{
            const obj = JSON.parse(raw);
            const inferred = extractDoneStagesFromJSON(obj);
            for (let i = 1; i <= STAGE_COUNT; i++){
              if (inferred[i]) done[i] = true;
            }
          }catch(e){ /* ignore */ }
        }
      }

      let count = 0;
      for (let i = 1; i <= STAGE_COUNT; i++){
        if (done[i]) count++;
      }
      return count;
    }

    function pct(doneCount){
      return Math.round((doneCount / STAGE_COUNT) * 100);
    }

    function resetAll(){
      const keys = getKeys();
      for (const key of keys){
        const parsed = parseUnitStageFromKey(key);
        if (parsed && parsed.unit >= 1 && parsed.unit <= 99 && parsed.stage >= 1 && parsed.stage <= 99){
          localStorage.removeItem(key);
          continue;
        }
        // Remove common unit progress blobs too
        if (key.toLowerCase().includes("unit") || key.toLowerCase().includes("progress") || key.toLowerCase().includes("stage")){
          localStorage.removeItem(key);
        }
      }
    }

    // -----------------------------
    // Render
    // -----------------------------
    const unitGrid = document.getElementById("unitGrid");
    const overallPill = document.getElementById("overallPill");
    const overallBar = document.getElementById("overallBar");
    const metaPill = document.getElementById("metaPill");

    function render(){
      metaPill.textContent = `Units: ${UNITS.length} • Stages: ${STAGE_COUNT} each`;
      unitGrid.innerHTML = "";

      let totalDone = 0;
      const totalStages = UNITS.length * STAGE_COUNT;

      for (const u of UNITS){
        const doneCount = getUnitDoneCount(u.n);
        const p = pct(doneCount);
        totalDone += doneCount;

        const card = document.createElement("div");
        card.className = "card";
        card.tabIndex = 0;

        card.innerHTML = `
          <h3>${u.title}</h3>
          <p>${u.desc}</p>
          <div class="bar"><div class="barFill" style="width:${p}%;"></div></div>
          <div class="cardRow">
            <span>Progress</span>
            <span class="pct">${p}%</span>
          </div>
        `;

        const go = () => window.location.href = u.href;
        card.addEventListener("click", go);
        card.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " "){ e.preventDefault(); go(); }
        });

        unitGrid.appendChild(card);
      }

      const overallPct = totalStages ? Math.round((totalDone / totalStages) * 100) : 0;
      overallPill.textContent = `Overall: ${overallPct}% complete`;
      overallBar.style.width = overallPct + "%";
    }

    document.getElementById("resetAllBtn").addEventListener("click", () => {
      if (!confirm("Reset ALL Level 1 progress in this browser?")) return;
      resetAll();
      render();
    });

    render();
  </script>
</body>
</html>
